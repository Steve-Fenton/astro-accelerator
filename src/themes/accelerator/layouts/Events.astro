---
// warning: This file is overwritten by Astro Accelerator

import { getCollection, render } from "astro:content";
import { SITE } from "@config";
import type { Frontmatter } from "astro-accelerator-utils/types/Frontmatter";
import TimelineEvent from "@components/TimelineEvent.astro";
import DefaultLayout from "./Default.astro";

type Props = {
    frontmatter: Frontmatter & { isArchive?: boolean };
    headings: { depth: number; slug: string; text: string }[];
};

const { frontmatter, headings } = Astro.props;
const isArchive = frontmatter.isArchive === true;

const renderedYears = await (async () => {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const collection = await getCollection("events", ({ data }) => {
        return isArchive ? data.startDate < today : data.startDate >= today;
    });

    const sortedEvents = collection.sort((a, b) => {
        const aTime = a.data.startDate.getTime();
        const bTime = b.data.startDate.getTime();
        return isArchive ? bTime - aTime : aTime - bTime;
    });

    const groupedEvents = sortedEvents.reduce(
        (acc, event) => {
            const year = event.data.startDate.getFullYear();
            if (!acc[year]) {
                acc[year] = [];
            }
            acc[year].push(event);
            return acc;
        },
        {} as Record<number, any[]>,
    );

    const years = Object.keys(groupedEvents)
        .map(Number)
        .sort((a, b) => (isArchive ? b - a : a - b));

    return Promise.all(
        years.map(async (year) => {
            const yearEvents = groupedEvents[year].map((event) => {
                return { event };
            });

            return { year, events: yearEvents };
        }),
    );
})();

const currentPath = Astro.url.pathname;
const basePath = isArchive
    ? currentPath.replace(/\/archive\/?$/, "")
    : currentPath.replace(/\/$/, "");
---

<DefaultLayout frontmatter={frontmatter} headings={headings}>
    <slot />

    {
        renderedYears.map(({ year, events }) => (
            <Fragment>
                <h2>{year}</h2>
                <div class="timeline" data-timeline>
                    {events.map(({ event }) => (
                        <TimelineEvent
                            date={event.data.startDate}
                            endDate={event.data.endDate}
                            title={event.data.title}
                            location={event.data.location}
                            description={event.data.description}
                            linkHref={event.data.linkHref}
                            linkText={event.data.linkText}
                            detailsHref={basePath + "/" + event.slug + "/"}
                        />
                    ))}
                </div>
            </Fragment>
        ))
    }
</DefaultLayout>

<style is:global>
    /* Events timeline */
    .timeline {
        --timeline-gap: 1rem;
        position: relative;
    }

    .timeline h2,
    .timeline h3 {
        margin: 0 0 0.5rem 0;
        font-size: var(--font-size-h4);
    }

    .timeline::before {
        background-color: var(--icon-block);
        bottom: 0;
        content: "";
        left: var(--timeline-gap);
        position: absolute;
        top: calc((var(--block-gap) + 1px) * -1);
        width: 0.4rem;
    }
</style>
